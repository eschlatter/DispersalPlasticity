---
title: "Untitled"
output: html_document
date: "2025-09-19"
---

```{r setup, include=FALSE}
library(tidyverse)
library(scales)
library(gridExtra)

source('functions/f_RunIBM.R')
source('functions/f_RunMatrixSim.R')
source('functions/f_RunMatrixSim_reversed.R')
source('functions/utility_functions.R')
```

# Parameters

```{r}
nx <- 10 # size of space in the x dimension
ny <- 10 # size of space in the y dimension

nsteps <- 100 # timesteps

# dispersal kernel is a gamma distribution, shape=alpha, scale=theta
v_alphas <- seq(from=0.01,to=0.61,by=0.2) # values the shape parameter can take
v_thetas <- seq(from=0.01,to=0.61,by=0.2) # values the scale parameter can take
alpha_start <- 1 # index (in v_alphas) of shape parameter initial value
theta_start <- 1 # index in (v_thetas) of scale parameter initial value

# plasticity parameter currently doesn't affect anything or evolve
v_p <- seq(from=0,to=0.9,length.out=2) # values the plasticity parameter can take
p_start <- 1 # index (in v_p) of plasticity parameter initial value

mu <- 0.01 # mutation frequency
# mutation increment specified by v_alphas, v_thetas
```


# Do a bunch of matrix sims and plot all the traces on the same graph

```{r}
nx <- 5 # size of space in the x dimension
ny <- 5 # size of space in the y dimension

nsteps <- 100 # timesteps

# dispersal kernel is a gamma distribution, shape=alpha, scale=theta
v_alphas <- seq(from=0.01,to=0.61,by=0.2) # values the shape parameter can take
v_thetas <- seq(from=0.01,to=0.61,by=0.2) # values the scale parameter can take
alpha_start <- 1 # index (in v_alphas) of shape parameter initial value
theta_start <- 1 # index in (v_thetas) of scale parameter initial value

# plasticity parameter currently doesn't affect anything or evolve
v_p <- seq(from=0,to=0.9,length.out=2) # values the plasticity parameter can take
p_start <- 1 # index (in v_p) of plasticity parameter initial value

mu <- 0.01 # mutation frequency
# mutation increment specified by v_alphas, v_thetas
b=3
K=60

sims <- data.frame(alpha_start=NA,alpha_from=NA,alpha_to=NA,alpha_nout=NA,theta_start=NA,theta_from=NA,theta_to=NA,theta_nout=NA)
sims[1,] <- data.frame(alpha_start=1,alpha_from=0.1,alpha_to=5,alpha_nout=5,theta_start=1,theta_from=0.1, theta_to=5,theta_nout=5)
sims[2,] <- data.frame(alpha_start=1,alpha_from=0.1,alpha_to=5,alpha_nout=5,theta_start=1,theta_from=0.1, theta_to=0.1,theta_nout=1)
sims$sim_num <- 1:nrow(sims)

for(i in 1:nrow(sims)){
  v_alphas <- seq(from=sims$alpha_from[i],to=sims$alpha_to[i],length.out=sims$alpha_nout[i])
  v_thetas <- seq(from=sims$theta_from[i],to=sims$theta_to[i],length.out=sims$theta_nout[i])
  
  matrix_out <- f_RunMatrixSim(nx,ny,nsteps,v_alphas,v_thetas,v_p,sims$alpha_start[i],sims$theta_start[i],p_start,mu,b,K,heatmap_plot_int=nsteps)
}
```


# Matrix sim

```{r}
b <- 3
v_alphas <- seq(from=0.1,to=5,length.out=5)
v_thetas <- seq(from=0.1,to=5,length.out=5)

matrix_out <- f_RunMatrixSim(nx=5,ny=5,nsteps=5000,v_alphas,v_thetas,v_p,alpha_start,theta_start,p_start,mu=0.01,b,K=60,heatmap_plot_int=5000)[[2]]

f_PlotOutput(matrix_out,kern_timesteps=seq(from=4000,by=50,to=5000),kern_xlim=1)

tail(matrix_out)
summarize(matrix_out[4000:5000,],med_alpha=median(alpha),med_theta=median(theta),med_popsize=median(popsize))
```


```{r}
b <- 3

matrix_out_2 <- f_RunMatrixSim(nx=10,ny=10,nsteps,v_alphas,v_thetas,v_p,alpha_start,theta_start,p_start,mu=0.1,b,K=60)[[2]]

f_PlotOutput(matrix_out_2,kern_timesteps=seq(from=400,by=10,to=500),kern_xlim=1)

tail(matrix_out_2)
```
# Run IBM once

```{r}
b <- 2
v_alphas=seq(from=0.1,to=6,length.out=5)
v_thetas=seq(from=0.1,to=10,length.out=5)

IBM_out <- f_RunIBM(nx,ny,nsteps=4000,v_alphas,v_thetas,v_p,alpha_start,theta_start,p_start,mu=0.01,b)[[2]]

f_PlotOutput(IBM_out, kern_timesteps=seq(from=2000,by=40,to=4000),kern_xlim = 50)
summarize(IBM_out[1000:4000,],med_alpha=median(alpha),med_theta=median(theta),med_popsize=median(popsize))
```

```{r}
b <- 2
IBM_out_2 <- f_RunIBM(nx,ny,nsteps=2000,v_alphas,v_thetas,v_p,alpha_start,theta_start,p_start,mu=0.1,b)

f_PlotOutput(IBM_out_2[[2]], kern_timesteps=seq(from=1000,by=20,to=2000))
```

# Run IBM multiple times
```{r}
b <- 2

kerns <- data.frame(alpha=NA,theta=NA)
sims <- list()

for(rep_i in 1:10){
  IBM_out <- f_RunIBM(nx,ny,nsteps,v_alphas,v_thetas,v_p,alpha_start,theta_start,p_start,mu,b)
  sims[[rep_i]] <- IBM_out
  
  kerns[rep_i,] <- data.frame(alpha=median(IBM_out$alpha[round(0.6*nsteps):nsteps]),theta=median(IBM_out$theta[round(0.6*nsteps):nsteps]))
}

ggplot()+
  xlim(0,25)+
  geom_function(fun=dgamma, args=list(shape=v_alphas[alpha_start],scale=v_thetas[theta_start]),aes(lty='first'))+
  lapply(1:nrow(kerns), function(i){geom_function(fun=dgamma,args=list(shape=kerns$alpha[i],scale=kerns$theta[i]),color='darkgray',aes(lty='last'))})+
  geom_function(fun=dgamma,args=list(shape=median(kerns$alpha),scale=median(kerns$theta)),color='black',lwd=0.75,aes(lty='last'))+
  scale_linetype_manual(values=c('first' = 'dashed',
                                 'last' = 'solid'),name='Kernel')+
  theme_minimal()+
  theme(legend.position='top')
```


