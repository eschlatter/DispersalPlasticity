---
title: "Untitled"
output: html_document
date: "2025-09-19"
---

```{r setup, include=FALSE}
library(tidyverse)
library(scales)
library(gridExtra)

source('functions/f_RunIBM.R')
source('functions/f_RunMatrixSim.R')
source('functions/f_RunMatrixSim2.R')
source('functions/utility_functions.R')
```

# Parameters

```{r}
nx <- 10 # size of space in the x dimension
ny <- 10 # size of space in the y dimension

nsteps <- 1000 # timesteps

# dispersal kernel is a gamma distribution, shape=alpha, scale=theta
v_alphas <- seq(from=0.1,to=5,length.out=5) # values the shape parameter can take
v_thetas <- seq(from=0.1,to=5,length.out=5) # values the scale parameter can take
alpha_start <- 1 # index (in v_alphas) of shape parameter initial value
theta_start <- 1 # index in (v_thetas) of scale parameter initial value

# plasticity parameter currently doesn't affect anything or evolve
v_p <- seq(from=0,to=0.9,length.out=10) # values the plasticity parameter can take
p_start <- 1 # index (in v_p) of plasticity parameter initial value

mu <- 0.01 # mutation frequency
# mutation increment specified by v_alphas, v_thetas
```


# Matrix sim

```{r}
b <- 3

matrix_out <- f_RunMatrixSim(nx,ny,nsteps,v_alphas,v_thetas,v_p,alpha_start=1,theta_start=1,p_start,mu=0.01,b,K=60)[[2]]

f_PlotOutput(matrix_out,kern_timesteps=seq(from=500,by=10,to=1000),kern_xlim=1)

tail(matrix_out)
```
```{r}
b <- 3

matrix_out_2 <- f_RunMatrixSim(nx,ny,nsteps,v_alphas,v_thetas,v_p,alpha_start,theta_start,p_start,mu=0.1,b,K=60)[[2]]

f_PlotOutput(matrix_out_2,kern_timesteps=seq(from=500,by=10,to=1000),kern_xlim=1)

tail(matrix_out_2)
```
# Run IBM once

```{r}
b <- 2
IBM_out <- f_RunIBM(nx,ny,nsteps=4000,v_alphas,v_thetas,v_p,alpha_start,theta_start,p_start,mu=0.01,b)

f_PlotOutput(IBM_out[[2]], kern_timesteps=seq(from=1500,by=40,to=4000))
```

```{r}
b <- 2
IBM_out_2 <- f_RunIBM(nx,ny,nsteps=2000,v_alphas,v_thetas,v_p,alpha_start,theta_start,p_start,mu=0.1,b)

f_PlotOutput(IBM_out_2[[2]], kern_timesteps=seq(from=1000,by=20,to=2000))
```

# Run IBM multiple times
```{r}
b <- 2

kerns <- data.frame(alpha=NA,theta=NA)
sims <- list()

for(rep_i in 1:10){
  IBM_out <- f_RunIBM(nx,ny,nsteps,v_alphas,v_thetas,v_p,alpha_start,theta_start,p_start,mu,b)
  sims[[rep_i]] <- IBM_out
  
  kerns[rep_i,] <- data.frame(alpha=median(IBM_out$alpha[round(0.6*nsteps):nsteps]),theta=median(IBM_out$theta[round(0.6*nsteps):nsteps]))
}

ggplot()+
  xlim(0,25)+
  geom_function(fun=dgamma, args=list(shape=v_alphas[alpha_start],scale=v_thetas[theta_start]),aes(lty='first'))+
  lapply(1:nrow(kerns), function(i){geom_function(fun=dgamma,args=list(shape=kerns$alpha[i],scale=kerns$theta[i]),color='darkgray',aes(lty='last'))})+
  geom_function(fun=dgamma,args=list(shape=median(kerns$alpha),scale=median(kerns$theta)),color='black',lwd=0.75,aes(lty='last'))+
  scale_linetype_manual(values=c('first' = 'dashed',
                                 'last' = 'solid'),name='Kernel')+
  theme_minimal()+
  theme(legend.position='top')
```


